name: Build and Deploy WordPress Theme

on:
  push:
    branches:
      - master

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    env:
      EC2_HOST: ${{ secrets.EC2_HOST }}
      EC2_USER: ${{ secrets.EC2_USER }}

    steps:
    - name: 📦 Checkout Repository
      uses: actions/checkout@v3

    - name: 🔧 Set up PHP 8.2
      uses: shivammathur/setup-php@v2
      with:
        php-version: 8.2

    - name: 🧰 Install Composer Dependencies
      run: |
        composer install --no-dev --optimize-autoloader

    - name: 🧱 Set up Node (from .nvmrc)
      uses: actions/setup-node@v3
      with:
        node-version-file: '.nvmrc'

    - name: 📥 Install Node Dependencies & Build Assets
      run: |
        npm install
        npm run build

    - name: 🔐 Set up SSH Agent
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

    - name: 🚀 Deploy to EC2 via rsync
      run: |
        rsync -avz --no-perms --no-times \
          --exclude='wp-content/uploads' \
          --exclude='wp-content/plugins' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./ $EC2_USER@$EC2_HOST:/var/www/serc_dev

    - name: ☁️ Sync uploads & plugins from S3 (optional)
      run: |
        ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'EOF'
          echo "🔄 Syncing plugins and uploads from S3..."
          aws s3 sync s3://serc-wp-content/dev/plugins /var/www/serc_dev/wp-content/plugins
          aws s3 sync s3://serc-wp-content/dev/uploads /var/www/serc_dev/wp-content/uploads
          echo "✅ S3 sync complete."
        EOF

    - name: 🧹 Fix Permissions on EC2
      run: |
        ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'EOF'
          sudo chown -R www-data:www-data /var/www/serc_dev/wp-content
          sudo find /var/www/serc_dev/wp-content -type d -exec chmod 755 {} \;
          sudo find /var/www/serc_dev/wp-content -type f -exec chmod 644 {} \;
          echo "✅ Permissions fixed."
        EOF
